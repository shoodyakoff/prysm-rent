# Задача: Отчет Rent Roll

## Описание

Создать страницу отчета Rent Roll - центральный инструмент для управления арендным портфелем с детальной аналитикой по договорам, арендаторам и финансовым показателям. Отчет включает сводные метрики, графическую аналитику по типам недвижимости и детальную таблицу всех действующих договоров.

## Что сделать

1. Создать страницу `/pages/rent-roll.html`
   - Использовать `components/header.html` и `components/sidebar.html` через `js/main.js`
   - **Важно:** Добавить атрибут `data-path-prefix="../"` в тег `<body>` для корректной загрузки компонентов из вложенной папки.
2. Подключить стили `../css/style.css` и скрипт `../js/main.js` (учитывая вложенность страницы)
3. Создать файл с мок-данными `js/rent-data.js` (или разместить данные внутри страницы) для работы без бэкенда
4. Реализовать блок из 6 ключевых метрик портфеля
5. Добавить систему табов по типам недвижимости (реализация на Vanilla JS)
6. Внутри каждого таба реализовать:
   - Блок с 3 метриками типа объекта
   - График распределения ставок (ApexCharts)
   - Круговую диаграмму по срокам договоров (ApexCharts)
   - Столбчатую диаграмму топ арендаторов (ApexCharts)
   - Детальную таблицу договоров (Custom JS / Grid.js)
7. Реализовать переключатель НДС
8. Добавить функционал поиска и фильтрации в таблице (Vanilla JS)
9. Реализовать кнопку "Назад" для возврата на главную

## Требования

### 1. Структура страницы

#### 1.1. Навигация

**Кнопка "Назад":**
- Расположение: левый верхний угол контентной области
- Иконка: `arrow-left` (Lucide)
- Текст: "Назад"
- При клике: возврат на `../index.html`
- Стиль: `color: var(--text-light)`, hover эффект

#### 1.2. Заголовок страницы

```html
<h1 class="page-title">Rent Roll</h1>
```

- Стили: Использовать класс `.page-title` из `style.css`
- Расположение: под кнопкой "Назад"

---

### 2. Блок ключевых метрик портфеля

**Расположение:** Под заголовком, перед табами

**Layout:** CSS Grid, 3 колонки × 2 строки, gap 16px (класс `.metrics-grid` можно переиспользовать или расширить)

#### 2.1. Список метрик (слева направо, сверху вниз)

**1. Количество договоров**
- Иконка: `file-text` (Lucide)
- Название: "Кол-во договоров"
- Значение: "62 шт"
- Класс модификатор: `.metric-optimization`
- Источник данных: Mock data (JS объект)

**2. Количество арендаторов**
- Иконка: `users` (Lucide)
- Название: "Кол-во арендаторов"
- Значение: "45 шт"
- Класс модификатор: `.metric-planning`

**3. Количество машино-мест**
- Иконка: `square-parking` (Lucide)
- Название: "Кол-во машино-мест"
- Значение: "1 276 шт"
- Класс модификатор: `.metric-control`

**4. Фактическая площадь: всего / сдано**
- Иконка: `scaling` (Lucide)
- Название: "Фактическая площадь: всего / сдано"
- Значение: "79 221 / 73 679 кв. м."
- Класс модификатор: `.metric-blue`

**5. Расчетная площадь: всего / сдано**
- Иконка: `scaling` (Lucide)
- Название: "Расчетная площадь: всего / сдано"
- Значение: "76 619 / 69 081 кв. м."
- Класс модификатор: `.metric-lilac`

**6. МАП в текущем месяце**
- Иконка: `ruble` (Lucide) или `banknote`
- Название: "МАП в текущем месяце"
- Значение: "25 023 986,00 ₽"
- Класс модификатор: `.metric-indigo`

**Общие стили карточек:**
- HTML структура: `<div class="metric-card [Класс модификатор]">`
- Иконки в `.metric-icon-circle`

---

### 3. Система табов по типам объектов

**Расположение:** Под блоком метрик, margin-top 32px

**Реализация:** Vanilla JS (переключение классов `.active` и скрытие/показ контента)

#### 3.1. Структура табов

**Табы (слева направо):**
1. **Офисы** - активный по умолчанию
2. **Машино-места**
3. **Склады**
4. **Тип объектов** - выпадающий список (custom dropdown)

**Стиль табов:**
- Активный таб: `background: var(--bg-dark)`, `color: #FFFFFF`
- Неактивный: `color: var(--text-light)`

---

### 4. Контент внутри таба

#### 4.1. Блок метрик типа объекта (3 карточки)

**Layout:** Flexbox, gap 16px

**Карточки:**
1. Активные договоры
2. Кол-во арендаторов
3. МАП в текущем месяце

**Стили:** Светлый фон (White), border `var(--border-dark)` (или `1px solid #E5E7EB`), скругление.

#### 4.2. График распределения ставок

**Тип:** Bar chart
**Библиотека:** ApexCharts (подключить через CDN)
**Данные:** Mock data в JS файле страницы.

**Пример конфига (JS):**
```javascript
var options = {
  chart: { type: 'bar', height: 300 },
  series: [{ name: 'Количество', data: [5, 10, 15, 8, 2] }],
  xaxis: { categories: ['<50', '50-60', '60-70', '70-80', '80+'] },
  colors: ['#8B5CF6'] // var(--primary-violet)
};
```

#### 4.3. Круговая диаграмма "Сроки договоров"

**Тип:** Pie / Donut
**Библиотека:** ApexCharts

#### 4.4. Столбчатая диаграмма "Топ арендаторов по площади"

**Тип:** Bar chart (horizontal)
**Библиотека:** ApexCharts

#### 4.5. Детальная таблица договоров

**Библиотека:** Custom JS implementation (генерация HTML из массива данных)

**Функционал:**
- Поиск (фильтрация массива данных и перерисовка)
- Сортировка (по клику на заголовок)
- Пагинация (слайсинг массива)
- Переключатель НДС (пересчет значений в массиве и перерисовка)

**Структура таблицы:**
- Использовать стандартные HTML теги `<table>`, `<thead>`, `<tbody>`
- Стилизовать в соответствии с `style.css` (добавить классы для таблиц при необходимости)

---

### 5. Логика переключателя НДС

**Реализация:**
- Checkbox / Toggle
- Event Listener `change`
- При изменении: обновляет глобальную переменную состояния `isVATIncluded` и вызывает функцию рендера таблицы и метрик.

---

### 6. Источники данных

**Техническая реализация:**
- Создать файл `js/mock-data.js` (или определить внутри скрипта страницы)
- Данные хранить в константах (JSON-like objects)
- **ВАЖНО:** Никаких запросов к реальному API. Использовать только локальные данные.

**Пример структуры данных:**
```javascript
const rentRollData = [
    { id: 1, tenant: "ООО Ромашка", area: 150, rate: 25000, type: "office", ... },
    // ...
];
```

**Исключения при расчете МАП:**
- Не учитываем договоры с % от оборота
- Не учитываем коммунальные платежи
- Учитываем только постоянную арендную плату

---

### 7. Поведение при переключении табов

**При клике на таб:**
1. Обновление активного состояния таба
2. Фильтрация всех данных по выбранному типу объекта
3. Пересчет метрик блока таба
4. Перерисовка графиков с новыми данными
5. Обновление таблицы с договорами этого типа
6. Сброс фильтров таблицы (опционально)
7. Плавная анимация перехода (transition 0.3s)

**При выборе из dropdown "Тип объектов":**
- Закрытие dropdown
- Обновление заголовка таба на выбранный тип
- Аналогичное поведение как при клике на обычный таб

---

### 8. Адаптивность и производительность

**Производительность:**
- Виртуализация таблицы при большом количестве строк (>100)
- Debounce при поиске (300ms)
- Мемоизация расчетов метрик
- Lazy loading графиков

**Оптимизация:**
- Использовать useMemo для тяжелых расчетов
- useCallback для обработчиков событий
- React.memo для компонентов карточек и графиков

---

## Критерии приемки

```gherkin
Сценарий: Переход на страницу Rent Roll с главной
  Дано пользователь находится на главной странице модуля "Аренда"
  Когда пользователь кликает на карточку отчета "Rent Roll"
  Тогда открывается страница отчета Rent Roll
  И отображается кнопка "Назад"
  И отображается заголовок "Rent Roll"
```

```gherkin
Сценарий: Возврат на главную страницу
  Дано пользователь находится на странице Rent Roll
  Когда пользователь кликает на кнопку "Назад"
  Тогда открывается главная страница модуля "Аренда"
```

```gherkin
Сценарий: Отображение блока ключевых метрик портфеля
  Дано пользователь открыл страницу Rent Roll
  Тогда отображается grid из 6 карточек метрик (3×2)
  И карточки слева направо в первой строке: "Кол-во договоров", "Кол-во арендаторов", "Кол-во машино-мест"
  И карточки слева направо во второй строке: "Фактическая площадь", "Расчетная площадь", "МАП в текущем месяце"
  И все карточки имеют градиентные фоны соответствующих цветов
  И все значения корректно рассчитаны из договоров
```

```gherkin
Сценарий: Метрики рассчитываются только из договоров
  Дано пользователь открыл страницу Rent Roll
  Тогда "Кол-во договоров" = количество активных договоров на текущую дату
  И "Кол-во арендаторов" = количество уникальных арендаторов с активными договорами
  И "Фактическая площадь: всего" = сумма фактических площадей всех объектов (без машино-мест)
  И "Фактическая площадь: сдано" = сумма фактических площадей по активным договорам
  И "Расчетная площадь: всего" = сумма расчетных площадей всех объектов (без машино-мест)
  И "Расчетная площадь: сдано" = сумма расчетных площадей по активным договорам
  И "Кол-во машино-мест" = машино-места по активным договорам
  И "МАП" = сумма МАП по активным договорам без учета % от оборота и коммуналки
```

```gherkin
Сценарий: Отображение табов по типам объектов
  Дано пользователь открыл страницу Rent Roll
  Тогда под метриками отображаются табы
  И табы слева направо: "Офисы", "Машино-места", "Склады", "Тип объектов"
  И таб "Офисы" активен по умолчанию
  И таб "Тип объектов" имеет иконку выпадающего списка
```

```gherkin
Сценарий: Переключение между табами
  Дано пользователь открыл страницу Rent Roll
  И таб "Офисы" активен
  Когда пользователь кликает на таб "Машино-места"
  Тогда таб "Машино-места" становится активным
  И контент таба обновляется данными по машино-местам
  И метрики блока таба пересчитываются для машино-мест
  И графики перерисовываются с данными по машино-местам
  И таблица показывает только договоры по машино-местам
```

```gherkin
Сценарий: Выбор типа из выпадающего списка
  Дано пользователь открыл страницу Rent Roll
  Когда пользователь кликает на таб "Тип объектов"
  Тогда открывается выпадающий список с типами: "Торговля", "Реклама", "Телекоммуникации", "Спецпроект", "Другое"
  Когда пользователь выбирает "Торговля"
  Тогда dropdown закрывается
  И заголовок таба меняется на "Торговля"
  И контент обновляется данными по торговле
```

```gherkin
Сценарий: Отображение блока метрик внутри таба
  Дано пользователь открыл страницу Rent Roll
  И таб "Офисы" активен
  Тогда под табами отображается блок из 3 карточек метрик
  И карточки слева направо: "Активные договоры", "Кол-во арендаторов", "МАП в текущем месяце"
  И все карточки имеют белый фон с серой рамкой
  И значения рассчитаны только для офисов
```

```gherkin
Сценарий: Отображение графика распределения ставок
  Дано пользователь открыл страницу Rent Roll
  И таб "Офисы" активен
  Тогда отображается график "Распределение ставок"
  И тип графика: столбчатая диаграмма (Bar chart)
  И ось X: диапазоны ставок (<50 тыс, 50-60 тыс, 60-70 тыс, 70-80 тыс, 80+ тыс)
  И ось Y: количество договоров
  И данные фильтруются по текущему типу объекта (офисы)
  И цвет столбцов: фиолетовый (#A78BFA)
```

```gherkin
Сценарий: Отображение круговой диаграммы сроков договоров
  Дано пользователь открыл страницу Rent Roll
  И таб "Офисы" активен
  Тогда отображается круговая диаграмма "Сроки договоров"
  И данные сгруппированы по категориям:
    | Краткосрочные (до 11 мес) | красный   |
    | Среднесрочные (1-5 лет)   | оранжевый |
    | Долгосрочные (от 5 лет)   | зеленый   |
  И справа отображается легенда с количеством договоров
  И данные фильтруются по офисам
```

```gherkin
Сценарий: Отображение столбчатой диаграммы топ арендаторов
  Дано пользователь открыл страницу Rent Roll
  И таб "Офисы" активен
  Тогда отображается горизонтальная столбчатая диаграмма "Топ арендаторов по площади"
  И показываются топ-5 арендаторов по занимаемой площади
  И данные отсортированы по убыванию площади
  И данные фильтруются по офисам
  И цвет столбцов: фиолетовый (#A78BFA)
```

```gherkin
Сценарий: Отображение детальной таблицы договоров
  Дано пользователь открыл страницу Rent Roll
  И таб "Офисы" активен
  Тогда под графиками отображается таблица договоров
  И таблица содержит 14 колонок:
    | Арендатор | Договор | Начало договора | Окончание договора | Начало условий | Окончание условий | Срок договора | Площадь фактическая | Площадь расчетная | Коэффициент | БАП | ЭП | МАП | Ставка |
  И в таблице отображаются только договоры по офисам
  И все финансовые показатели с НДС (по умолчанию)
```

```gherkin
Сценарий: Поиск в таблице договоров
  Дано пользователь открыл страницу Rent Roll
  И таблица содержит 50 договоров
  Когда пользователь вводит "ООО Ромашка" в поле поиска
  Тогда таблица фильтруется и показывает только договоры с "ООО Ромашка" в названии арендатора
  И количество строк уменьшается
  И поиск работает в реальном времени (debounce 300ms)
```

```gherkin
Сценарий: Сортировка колонок таблицы
  Дано пользователь открыл страницу Rent Roll
  Когда пользователь кликает на заголовок колонки "МАП"
  Тогда таблица сортируется по МАП по возрастанию
  И рядом с заголовком появляется стрелка вверх
  Когда пользователь кликает повторно на "МАП"
  Тогда таблица сортируется по МАП по убыванию
  И стрелка меняется на вниз
```

```gherkin
Сценарий: Фильтрация колонок таблицы
  Дано пользователь открыл страницу Rent Roll
  Когда пользователь кликает на кнопку "Фильтры"
  Тогда открывается панель с фильтрами для каждой колонки
  Когда пользователь устанавливает фильтр "Площадь фактическая от 100 до 500"
  Тогда таблица показывает только договоры с площадью 100-500 м²
  И фильтр применяется автоматически
```

```gherkin
Сценарий: Управление видимостью колонок
  Дано пользователь открыл страницу Rent Roll
  Когда пользователь кликает на кнопку "Столбцы"
  Тогда открывается список всех колонок с чекбоксами
  И все колонки отмечены как видимые
  Когда пользователь снимает чекбокс "Начало условий"
  Тогда колонка "Начало условий" скрывается из таблицы
  И выбор сохраняется в localStorage
```

```gherkin
Сценарий: Переключение НДС в значение "Без НДС"
  Дано пользователь открыл страницу Rent Roll
  И переключатель НДС в позиции "С НДС"
  И МАП в верхней карточке = 25 023 986,00 ₽
  Когда пользователь переключает на "Без НДС"
  Тогда МАП в верхней карточке пересчитывается без НДС (делится на 1.20)
  И МАП в блоке метрик таба пересчитывается без НДС
  И в таблице колонки БАП, ЭП, МАП, Ставка пересчитываются без НДС
  И пересчет происходит с плавной анимацией (transition 0.3s)
```

```gherkin
Сценарий: Переключение НДС в значение "С НДС"
  Дано пользователь открыл страницу Rent Roll
  И переключатель НДС в позиции "Без НДС"
  Когда пользователь переключает на "С НДС"
  Тогда все финансовые показатели умножаются на 1.20
  И значения обновляются с анимацией
```

```gherkin
Сценарий: Формулы расчета МАП корректны
  Дано в системе есть договор:
    | БАП (без НДС) | 1 200 000 ₽/год |
    | ЭП (без НДС)  | 300 000 ₽/год   |
  Когда переключатель НДС в позиции "С НДС"
  Тогда МАП = (1 200 000 + 300 000) × 1.20 / 12 = 150 000 ₽/мес
  Когда переключатель НДС в позиции "Без НДС"
  Тогда МАП = (1 200 000 + 300 000) / 12 = 125 000 ₽/мес
```

```gherkin
Сценарий: Исключения при расчете МАП применяются
  Дано в системе есть договоры:
    | Договор 1 | постоянная аренда | БАП 1 000 000 | ЭП 0       |
    | Договор 2 | % от оборота      | БАП 0         | ЭП 0       |
    | Договор 3 | коммуналка        | БАП 0         | ЭП 500 000 |
  Когда пользователь открыл страницу Rent Roll
  Тогда карточка "МАП в текущем месяце" учитывает только Договор 1
  И Договоры 2 и 3 не учитываются в расчете МАП
  И в таблице отображаются все 3 договора
```

```gherkin
Сценарий: Пагинация таблицы работает
  Дано пользователь открыл страницу Rent Roll
  И в таблице 150 договоров
  И установлено отображение 25 строк на странице
  Тогда отображается страница 1 из 6
  И показываются первые 25 договоров
  Когда пользователь кликает "Следующая страница"
  Тогда отображается страница 2 из 6
  И показываются договоры 26-50
```

```gherkin
Сценарий: Изменение количества строк на странице
  Дано пользователь открыл страницу Rent Roll
  И установлено отображение 10 строк на странице
  Когда пользователь выбирает "50 строк на странице"
  Тогда таблица перерисовывается с 50 строками
  И пагинация пересчитывается
  И пользователь остается на странице 1
```

```gherkin
Сценарий: Hover эффекты на карточках метрик
  Дано пользователь открыл страницу Rent Roll
  Когда пользователь наводит курсор на карточку "Кол-во договоров"
  Тогда карточка поднимается вверх (transform: translateY(-4px))
  И появляется тень (box-shadow)
  И переход плавный (transition 0.2s)
```

```gherkin
Сценарий: Все графики корректно отрисовываются
  Дано пользователь открыл страницу Rent Roll
  И таб "Офисы" активен
  Тогда отображается график "Распределение ставок" (Bar chart)
  И отображается диаграмма "Сроки договоров" (Pie chart)
  И отображается диаграмма "Топ арендаторов по площади" (Horizontal Bar chart)
  И все графики используют библиотеку Recharts
  И все графики имеют корректные данные и легенды
```

```gherkin
Сценарий: Производительность при большом количестве данных
  Дано пользователь открыл страницу Rent Roll
  И в таблице 500+ договоров
  Когда пользователь прокручивает таблицу
  Тогда используется виртуализация строк
  И отображаются только видимые строки + буфер
  И прокрутка плавная без лагов
```

```gherkin
Сценарий: Debounce при поиске работает
  Дано пользователь открыл страницу Rent Roll
  Когда пользователь начинает вводить "ООО" в поле поиска
  Тогда поиск не запускается сразу
  Когда прошло 300ms после последнего ввода
  Тогда запускается фильтрация таблицы
  И таблица обновляется с результатами поиска
```

---

## Открытые вопросы

**1. Источник данных для коэффициента площади:**
- Где хранится коэффициент между фактической и расчетной площадью?
- Рассчитывается автоматически (расчетная / фактическая) или вводится вручную?

**2. Логика отображения дополнительных соглашений:**
- Показывать ли все ДС в одной строке или только последнее?
- Формат: "№ договора (ДС №1, №2, №3)" или "№ договора (ДС №3 от дата)"?

**3. Фильтрация в выпадающем списке "Тип объектов":**
- Показывать ли только те типы, по которым есть активные договоры?
- Или всегда показывать все типы, даже если нет договоров?

**4. Период действия договора для активности:**
- Договор считается активным если текущая дата >= дата начала И <= дата окончания?
- Или есть дополнительное поле "статус договора"?

**5. Расчет среднего срока для круговой диаграммы:**
- Краткосрочные до 11 мес или до 1 года включительно?
- Среднесрочные 1-5 лет или >1 и <=5 лет?

**6. Сохранение состояния фильтров:**
- Сохранять ли выбранные фильтры при переключении табов?
- Или сбрасывать фильтры при смене типа объекта?

**7. Группировка арендаторов:**
- Что означает "Арендатор (группа)" в колонке таблицы?
- Это название группы компаний или юридическое лицо?
- Показывать и то и другое?

---

## Не входит в задачу

- Экспорт таблицы в CSV/XLSX (только визуал)
- Редактирование данных договоров из таблицы
- Создание новых договоров
- Печать отчета в PDF
- Email-уведомления о критичных договорах
- Интеграция с внешними системами (1С, банк-клиент)
- История изменений договоров
- Комментарии и заметки к договорам
- Загрузка документов договоров
- Календарь критических дат
- Мобильная версия отчета
- Сравнение периодов (месяц к месяцу)
- Прогнозирование доходов
- Детальная аналитика по каждому арендатору (отдельная страница)